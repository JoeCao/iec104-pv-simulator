# IEC 104 光伏电站模拟器 - 点位表与变化规则

## 概述

本模拟器模拟一个小型光伏电站，包含 3 台逆变器（每台额定功率 30kW，总装机容量 90kW）。

- **协议**: IEC 60870-5-104
- **监听端口**: 2404
- **站地址 (Common Address)**: 1

---

## 点位表

### 1. 逆变器数据 (IOA 1-30)

每台逆变器 10 个测点，共 3 台逆变器。

| IOA | 名称 | 类型 | 单位 | 描述 | 典型范围 |
|-----|------|------|------|------|----------|
| **逆变器 1 (IOA 1-10)** |||||
| 1 | INV1_DC_Voltage | M_ME_NC_1 | V | 直流侧电压 | 600-750 |
| 2 | INV1_DC_Current | M_ME_NC_1 | A | 直流侧电流 | 0-45 |
| 3 | INV1_DC_Power | M_ME_NC_1 | kW | 直流侧功率 | 0-33 |
| 4 | INV1_AC_Voltage_A | M_ME_NC_1 | V | A相交流电压 | 395-405 |
| 5 | INV1_AC_Voltage_B | M_ME_NC_1 | V | B相交流电压 | 395-405 |
| 6 | INV1_AC_Voltage_C | M_ME_NC_1 | V | C相交流电压 | 395-405 |
| 7 | INV1_AC_Current_A | M_ME_NC_1 | A | A相交流电流 | 0-45 |
| 8 | INV1_AC_Current_B | M_ME_NC_1 | A | B相交流电流 | 0-45 |
| 9 | INV1_AC_Current_C | M_ME_NC_1 | A | C相交流电流 | 0-45 |
| 10 | INV1_AC_Power | M_ME_NC_1 | kW | 交流侧有功功率 | 0-30 |
| **逆变器 2 (IOA 11-20)** |||||
| 11 | INV2_DC_Voltage | M_ME_NC_1 | V | 直流侧电压 | 600-750 |
| 12 | INV2_DC_Current | M_ME_NC_1 | A | 直流侧电流 | 0-45 |
| 13 | INV2_DC_Power | M_ME_NC_1 | kW | 直流侧功率 | 0-33 |
| 14 | INV2_AC_Voltage_A | M_ME_NC_1 | V | A相交流电压 | 395-405 |
| 15 | INV2_AC_Voltage_B | M_ME_NC_1 | V | B相交流电压 | 395-405 |
| 16 | INV2_AC_Voltage_C | M_ME_NC_1 | V | C相交流电压 | 395-405 |
| 17 | INV2_AC_Current_A | M_ME_NC_1 | A | A相交流电流 | 0-45 |
| 18 | INV2_AC_Current_B | M_ME_NC_1 | A | B相交流电流 | 0-45 |
| 19 | INV2_AC_Current_C | M_ME_NC_1 | A | C相交流电流 | 0-45 |
| 20 | INV2_AC_Power | M_ME_NC_1 | kW | 交流侧有功功率 | 0-30 |
| **逆变器 3 (IOA 21-30)** |||||
| 21 | INV3_DC_Voltage | M_ME_NC_1 | V | 直流侧电压 | 600-750 |
| 22 | INV3_DC_Current | M_ME_NC_1 | A | 直流侧电流 | 0-45 |
| 23 | INV3_DC_Power | M_ME_NC_1 | kW | 直流侧功率 | 0-33 |
| 24 | INV3_AC_Voltage_A | M_ME_NC_1 | V | A相交流电压 | 395-405 |
| 25 | INV3_AC_Voltage_B | M_ME_NC_1 | V | B相交流电压 | 395-405 |
| 26 | INV3_AC_Voltage_C | M_ME_NC_1 | V | C相交流电压 | 395-405 |
| 27 | INV3_AC_Current_A | M_ME_NC_1 | A | A相交流电流 | 0-45 |
| 28 | INV3_AC_Current_B | M_ME_NC_1 | A | B相交流电流 | 0-45 |
| 29 | INV3_AC_Current_C | M_ME_NC_1 | A | C相交流电流 | 0-45 |
| 30 | INV3_AC_Power | M_ME_NC_1 | kW | 交流侧有功功率 | 0-30 |

### 2. 环境监测数据 (IOA 100-105)

| IOA | 名称 | 类型 | 单位 | 描述 | 典型范围 |
|-----|------|------|------|------|----------|
| 100 | Irradiance | M_ME_NC_1 | W/m² | 太阳辐照度 | 0-1200 |
| 101 | Ambient_Temp | M_ME_NC_1 | °C | 环境温度 | 10-40 |
| 102 | Module_Temp | M_ME_NC_1 | °C | 组件温度 | 10-70 |
| 103 | Wind_Speed | M_ME_NC_1 | m/s | 风速 | 0-15 |
| 104 | Wind_Direction | M_ME_NC_1 | ° | 风向 | 0-360 |
| 105 | Humidity | M_ME_NC_1 | % | 相对湿度 | 20-95 |

### 3. 电站汇总数据 (IOA 200-205)

| IOA | 名称 | 类型 | 单位 | 描述 | 典型范围 |
|-----|------|------|------|------|----------|
| 200 | Total_Active_Power | M_ME_NC_1 | kW | 总有功功率 | 0-90 |
| 201 | Total_Reactive_Power | M_ME_NC_1 | kVar | 总无功功率 | 0-5 |
| 202 | Power_Factor | M_ME_NC_1 | - | 功率因数 | 0.95-1.0 |
| 203 | Grid_Frequency | M_ME_NC_1 | Hz | 电网频率 | 49.9-50.1 |
| 204 | Daily_Energy | M_ME_NC_1 | kWh | 日发电量 | 0-500 |
| 205 | Total_Energy | M_ME_NC_1 | MWh | 累计发电量 | 递增 |

### 4. 逆变器状态 (IOA 1001-1003)

| IOA | 名称 | 类型 | 描述 |
|-----|------|------|------|
| 1001 | INV1_Status | M_SP_NA_1 | 逆变器1运行状态 (1=运行, 0=停机) |
| 1002 | INV2_Status | M_SP_NA_1 | 逆变器2运行状态 (1=运行, 0=停机) |
| 1003 | INV3_Status | M_SP_NA_1 | 逆变器3运行状态 (1=运行, 0=停机) |

### 5. 逆变器控制命令 (IOA 2001-2003)

| IOA | 名称 | 类型 | 描述 |
|-----|------|------|------|
| 2001 | INV1_Control | C_SC_NA_1 | 逆变器1启停控制 (1=启动, 0=停止) |
| 2002 | INV2_Control | C_SC_NA_1 | 逆变器2启停控制 (1=启动, 0=停止) |
| 2003 | INV3_Control | C_SC_NA_1 | 逆变器3启停控制 (1=启动, 0=停止) |

---

## IEC 104 类型标识说明

| TypeID | 名称 | 描述 |
|--------|------|------|
| 1 | M_SP_NA_1 | 单点遥信 (不带时标) |
| 13 | M_ME_NC_1 | 短浮点数遥测 (不带时标) |
| 45 | C_SC_NA_1 | 单点遥控命令 |
| 100 | C_IC_NA_1 | 总召唤命令 |

---

## 数据变化规则

### 1. 太阳辐照模拟

模拟器根据系统时间模拟真实的太阳辐照曲线：

```
太阳系数 = sin((当前小时 - 6) / 12 × π) × 云层因子

其中：
- 有效时段: 06:00 - 18:00
- 夜间 (18:00 - 06:00): 太阳系数 = 0
- 云层因子: 0.85 - 1.15 (随机波动 ±15%)
```

**辐照度曲线示意**:
```
辐照度 (W/m²)
    ^
1000|           ****
    |         **    **
 800|        *        *
    |       *          *
 600|      *            *
    |     *              *
 400|    *                *
    |   *                  *
 200|  *                    *
    | *                      *
  0 |*________________________*____> 时间
    6   8  10  12  14  16  18
```

### 2. 逆变器数据计算

#### DC 侧 (直流)
- **DC电压**: `600 + 太阳系数 × 150 + 随机波动(±10V)`
- **DC电流**: `太阳系数 × 45A + 随机波动(±2A)`
- **DC功率**: `DC电压 × DC电流 / 1000` (kW)

#### AC 侧 (交流)
- **AC电压**: `400V + 随机波动(±5V)` (三相基本平衡)
- **AC功率**: `DC功率 × 0.97` (逆变效率 97%)
- **AC电流**: `AC功率 × 1000 / (400 × √3)` (三相平衡)

#### 停机状态
当逆变器被遥控停机后：
- DC电压保持 (光伏组件开路电压)
- DC电流、DC功率、AC电流、AC功率 = 0

### 3. 环境数据变化

| 参数 | 变化规则 |
|------|----------|
| 辐照度 | `太阳系数 × 1000 + 随机波动(±50)`, 范围 0-1200 |
| 环境温度 | 基于正弦曲线的日变化 (20-30°C) + 随机波动(±2°C) |
| 组件温度 | `环境温度 + 太阳系数 × 25°C + 随机波动(±3°C)` |
| 风速 | `3 m/s + 随机波动(±4 m/s)`, 最小 0 |
| 风向 | 缓慢漂移 + 随机波动(±10°), 范围 0-360° |
| 湿度 | `70% - 太阳系数 × 20% + 随机波动(±5%)`, 范围 20-95% |

### 4. 电站汇总计算

| 参数 | 计算公式 |
|------|----------|
| 总有功功率 | `Σ(各逆变器AC功率)` |
| 总无功功率 | `总有功功率 × 0.05 + 随机波动(±2)` |
| 功率因数 | 有功时 `0.98 + 随机波动(±0.01)`, 无功时 `1.0` |
| 电网频率 | `50.0 Hz + 随机波动(±0.1 Hz)` |
| 日发电量 | `累加(总功率 / 3600)` kWh (每秒累加) |
| 累计发电量 | `累加(总功率 / 3600000)` MWh |

---

## 变化上报规则 (Spontaneous, COT=3)

### 上报条件

模拟器采用 **变化死区 + 最小间隔** 的上报策略：

| 数据类型 | 变化阈值 | 最小间隔 |
|----------|----------|----------|
| 逆变器数据 | 1.0 | 5 秒 |
| 辐照度 | 50.0 W/m² | 5 秒 |
| 其他环境数据 | 1.0 | 5 秒 |
| 电量数据 | 10.0 kWh | 5 秒 |
| 其他电站数据 | 1.0 | 5 秒 |
| 逆变器状态 | 任何变化 | 立即 |

### 上报逻辑

```
如果 |当前值 - 上次上报值| >= 阈值 且 当前时间 - 上次上报时间 >= 5秒:
    发送变化上报 (COT=3)
    更新上次上报值和时间
```

---

## 总召唤响应 (General Interrogation)

### 触发条件
- 收到 QOI=20 (站召唤) 的总召唤命令

### 响应流程

```
1. 发送 ACT_CON (确认)
2. 发送逆变器数据 IOA 1-30 (M_ME_NC_1, COT=20)
3. 发送环境数据 IOA 100-105 (M_ME_NC_1, COT=20)
4. 发送电站汇总 IOA 200-205 (M_ME_NC_1, COT=20)
5. 发送逆变器状态 IOA 1001-1003 (M_SP_NA_1, COT=20)
6. 发送 ACT_TERM (结束)
```

---

## 遥控命令处理

### 支持的命令

| 命令 | IOA | 动作 |
|------|-----|------|
| 启动逆变器1 | 2001 | 值=1 |
| 停止逆变器1 | 2001 | 值=0 |
| 启动逆变器2 | 2002 | 值=1 |
| 停止逆变器2 | 2002 | 值=0 |
| 启动逆变器3 | 2003 | 值=1 |
| 停止逆变器3 | 2003 | 值=0 |

### 响应流程

```
1. 收到 C_SC_NA_1 命令
2. 解析 IOA 和命令值
3. 执行状态切换
4. 发送 ACT_CON (确认)
5. 状态变化触发 M_SP_NA_1 变化上报 (COT=3)
```

---

## 数据更新周期

| 操作 | 周期 |
|------|------|
| 数据计算更新 | 1 秒 |
| 变化检测与上报 | 1 秒 |
| 控制台状态打印 | 10 秒 |

---

## 典型日发电曲线

以晴天为例，电站总功率随时间变化：

```
功率 (kW)
   ^
 90|              ****
   |            **    **
 75|           *        *
   |          *          *
 60|         *            *
   |        *              *
 45|       *                *
   |      *                  *
 30|     *                    *
   |    *                      *
 15|   *                        *
   |  *                          *
  0|_*____________________________*___> 时间
    6   8  10  12  14  16  18  20
```

**日发电量估算**: 约 400-500 kWh (晴天)
